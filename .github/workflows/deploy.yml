# .github/workflows/deploy.yml
name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # fail on error

            # –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            mkdir -p "$PROJECT_PATH"

            # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ (–∫—Ä–æ–º–µ .git)
            cd "$PROJECT_PATH"
            rsync -av --delete --exclude='.git' $GITHUB_WORKSPACE/ ./

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Airflow
            if [ -f "docker-compose.yml" ]; then
              echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–µ–∫..."
              docker-compose down --remove-orphans || true

              echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã..."
              docker-compose build --pull

              echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–µ–∫..."
              docker-compose up -d

              echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:"
              sleep 10
              docker-compose logs airflow-init | tail -20
            else
              echo "‚ùå docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi